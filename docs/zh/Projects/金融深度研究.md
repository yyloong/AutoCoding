# é‡‘èæ·±åº¦ç ”ç©¶

Ms-Agentçš„ FinResearch é¡¹ç›®æ˜¯ä¸€ä¸ªé¢å‘é‡‘èå¸‚åœºç ”ç©¶åœºæ™¯çš„å¤šæ™ºèƒ½ä½“å·¥ä½œæµï¼Œèåˆäº†å®šé‡é‡‘èæ•°æ®åˆ†æèƒ½åŠ›ä¸äº’è”ç½‘èˆ†æƒ…/èµ„è®¯æ·±åº¦ç ”ç©¶èƒ½åŠ›ï¼Œè‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–çš„ä¸“ä¸šç ”ç©¶æŠ¥å‘Šã€‚

## åŸç†ä»‹ç»

### ç‰¹æ€§

- **å¤šæ™ºèƒ½ä½“æ¶æ„**ï¼šOrchestrator / Searcher / Collector / Analyst / Aggregator äº”ä¸ªä¸“ç”¨æ™ºèƒ½ä½“ä»¥ DAG å½¢å¼ååŒå®Œæˆä»ä»»åŠ¡æ‹†è§£åˆ°æŠ¥å‘Šèšåˆçš„å…¨æµç¨‹ã€‚
- **å¤šç»´åº¦ç ”ç©¶**ï¼šåŒæ—¶è¦†ç›–â€œé‡‘èæ•°æ®ï¼ˆå®šé‡ï¼‰+ èˆ†æƒ…èµ„è®¯ï¼ˆå®šæ€§ï¼‰â€ï¼Œå®ç°ç»“æ„åŒ–ä¸éç»“æ„åŒ–æ•°æ®çš„èåˆåˆ†æï¼Œç»“è®ºæ›´å…¨é¢ã€æ›´å…·è§£é‡Šæ€§ã€‚
- **é‡‘èæ•°æ®é‡‡é›†**ï¼šæ”¯æŒæ¨¡å‹è‡ªåŠ¨è·å–Aè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡ç­‰å¸‚åœºçš„è¡Œæƒ…ã€è´¢æŠ¥ã€å®è§‚æŒ‡æ ‡ä¸å¸‚åœºæ•°æ®ã€‚
- **èˆ†æƒ…æ·±åº¦ç ”ç©¶**ï¼šæ–°é—»/åª’ä½“/ç¤¾åŒºç­‰å¤šæºèˆ†æƒ…æ·±åº¦åˆ†æã€‚
- **å®‰å…¨å¯å¤ç°**ï¼šé‡åŒ–åˆ†æåœ¨ Docker æ²™ç®±ä¸­æ‰§è¡Œï¼Œä¿è¯ç¯å¢ƒéš”ç¦»ä¸å¯å¤ç°æ€§ã€‚
- **ä¸“ä¸šæŠ¥å‘Šè¾“å‡º**ï¼šéµå¾ª MECEã€SWOTã€é‡‘å­—å¡”åŸç†ç­‰æ–¹æ³•è®ºï¼Œé€ç« ç”Ÿæˆå¹¶è·¨ç« èŠ‚è¿›è¡Œä¸€è‡´æ€§æ ¡éªŒã€‚

### æ¶æ„

```text
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Orchestratorâ”‚
                    â”‚   Agent     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                         â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   Searcher   â”‚          â”‚  Collector   â”‚
      â”‚    Agent     â”‚          â”‚    Agent     â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚
             â”‚                         â–¼
             â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                  â”‚   Analyst    â”‚
             â”‚                  â”‚    Agent     â”‚
             â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Aggregator  â”‚
                   â”‚    Agent     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Orchestrator**ï¼šæ‹†è§£ç”¨æˆ·ä»»åŠ¡ä¸ºä»»åŠ¡ä¸èŒƒå›´ã€é‡‘èæ•°æ®ä»»åŠ¡ã€èˆ†æƒ…ç ”ç©¶ä»»åŠ¡ä¸‰éƒ¨åˆ†ã€‚
- **Searcher**ï¼šéç»“æ„åŒ–æ•°æ®æœé›†ï¼Œè°ƒç”¨ `ms-agent/projects/deep_research` æ‰§è¡Œèˆ†æƒ…æ·±åº¦ç ”ç©¶ï¼Œè¾“å‡ºèˆ†æƒ…åˆ†ææŠ¥å‘Šã€‚
- **Collector**ï¼šé‡‘èç»“æ„åŒ–æ•°æ®æœé›†ï¼ŒæŒ‰ä»»åŠ¡æ¸…å•é‡‡é›†è´¢æŠ¥ã€å®è§‚æŒ‡æ ‡ç­‰é‡‘èæ•°æ®ï¼Œä½¿ç”¨`FinancialDataFetcher`å·¥å…·è·å–ï¼ˆåŸºäº`akshare`å’Œ`baostock`æ¥å£å®ç°ï¼‰ã€‚
- **Analyst**ï¼šåœ¨æ²™ç®±å†…æ‰§è¡Œå®šé‡åˆ†æï¼Œäº§å‡ºæ•°æ®åˆ†ææŠ¥å‘Šï¼ˆå¸¦æœ‰å¯è§†åŒ–ç»“æœï¼‰ã€‚
- **Aggregator**ï¼šæ•´åˆèˆ†æƒ…åˆ†æä¸å®šé‡åˆ†æç»“æœï¼Œé€ç« ç”ŸæˆæŠ¥å‘Šå¹¶è¿›è¡Œä¸€è‡´æ€§æ ¡éªŒï¼Œæœ€ååˆæˆç»¼åˆç ”ç©¶æŠ¥å‘Šã€‚

## ä½¿ç”¨æ–¹å¼

### Pythonç¯å¢ƒ

```bash
# æºç ä¸‹è½½
git clone https://github.com/modelscope/ms-agent.git
cd ms-agent

# Python ç¯å¢ƒ
conda create -n fin_research python=3.11
conda activate fin_research
# ä» PyPI å®‰è£…ï¼ˆ>=v1.5.0ï¼‰
pip install 'ms-agent[research]'
# ä»æºç å®‰è£…
pip install -r requirements/framework.txt
pip install -r requirements/research.txt
pip install -e .

# æ•°æ®æ¥å£ä¾èµ–
pip install akshare baostock
```

### æ²™ç®±ç¯å¢ƒ

```bash
# å®‰è£… ms-enclaveï¼ˆhttps://github.com/modelscope/ms-enclaveï¼‰
pip install ms-enclave docker websocket-client

# æ„å»ºæ‰€éœ€ Docker é•œåƒï¼ˆç¡®ä¿è®¾å¤‡å·²å®‰è£…å¹¶è¿è¡Œ Dockerï¼‰
bash projects/fin_research/tools/build_jupyter_image.sh
```

### ç¯å¢ƒå˜é‡

åœ¨ç³»ç»Ÿç¯å¢ƒæˆ– YAML ä¸­é…ç½® API Keyï¼š

```bash
# LLM APIï¼ˆç³»ç»Ÿç¯å¢ƒé…ç½®ç¤ºä¾‹ï¼‰
export OPENAI_API_KEY=your_api_key
export OPENAI_BASE_URL=your-api-url

# æœç´¢å¼•æ“ï¼ˆç”¨äºèˆ†æƒ…ç ”ç©¶ï¼Œå¯é€‰ exa æˆ– serpapiï¼‰ï¼Œä¸‹åˆ—æœåŠ¡å‡æä¾›ä¸€å®šçš„å…è´¹é¢åº¦ï¼Œè¯·æ³¨å†Œå¹¶é…ç½®API Key
# exaè´¦å·æ³¨å†Œåœ°å€ä¸ºhttps://exa.aiï¼ŒSerpApiè´¦å·æ³¨å†Œåœ°å€ä¸ºhttps://serpapi.com
# å¦‚æœä¸å¸Œæœ›é…ç½®æœç´¢å¼•æ“å°±å¯åŠ¨FinResearché¡¹ç›®è¿›è¡Œæµ‹è¯•ï¼Œå¯è·³è¿‡å¹¶å‚è€ƒå¿«é€Ÿå¯åŠ¨ä¸€èŠ‚
export EXA_API_KEY=your_exa_api_key
export SERPAPI_API_KEY=your_serpapi_api_key
```

åœ¨ `searcher.yaml` æŒ‡å®šæœç´¢å¼•æ“é…ç½®ï¼š

```yaml
tools:
  search_engine:
    config_file: projects/fin_research/conf.yaml
```

### å¿«é€Ÿå¯åŠ¨

å¿«é€Ÿå¯åŠ¨å®Œæ•´FinResearchå·¥ä½œæµè¿›è¡Œæµ‹è¯•ï¼š

```bash
# åœ¨ ms-agent æ ¹ç›®å½•æ‰§è¡Œ
PYTHONPATH=. python ms_agent/cli/cli.py run \
  --config projects/fin_research \
  --query 'è¯·åˆ†æå®å¾·æ—¶ä»£ï¼ˆ300750.SZï¼‰è¿‘å››ä¸ªå­£åº¦ç›ˆåˆ©èƒ½åŠ›å˜åŒ–ï¼Œå¹¶ä¸æ–°èƒ½æºé¢†åŸŸä¸»è¦ç«äº‰å¯¹æ‰‹è¿›è¡Œå¯¹æ¯”ï¼›ç»“åˆäº§ä¸šæ”¿ç­–ä¸é”‚ä»·æ³¢åŠ¨ï¼Œé¢„æµ‹å…¶æœªæ¥ä¸¤å­£åº¦è¶‹åŠ¿ã€‚' \
  --trust_remote_code true
```

åœ¨æ²¡æœ‰é…ç½®æœç´¢å¼•æ“æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œå…è®¸é…ç½®æœ€å°ç‰ˆæœ¬FinResearchå·¥ä½œæµè¿›è¡Œæµ‹è¯•ï¼ˆæ— èˆ†æƒ…æ·±åº¦ç ”ç©¶éƒ¨åˆ†ï¼‰ï¼Œéœ€è¦ä¿®æ”¹workflow.yamlæ–‡ä»¶å¦‚ä¸‹ï¼š

```bash
type: DagWorkflow

orchestrator:
  next:
    - collector
  agent_config: orchestrator.yaml

collector:
  next:
    - analyst
  agent_config: collector.yaml

analyst:
  next:
    - aggregator
  agent_config: analyst.yaml

aggregator:
  agent_config: aggregator.yaml
```

éšååœ¨å‘½ä»¤è¡Œä¸­æŒ‰ä¹‹å‰ç›¸åŒçš„æ–¹å¼å¯åŠ¨å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºä¿¡æ¯ç»´åº¦ä¸å…¨é¢ï¼ŒFinResearchå¯èƒ½æ— æ³•å¯¹å¤æ‚é—®é¢˜ç»™å‡ºç¯‡å¹…è¾ƒé•¿ã€å†…å®¹ä¸°å¯Œçš„åˆ†ææŠ¥å‘Šï¼Œå»ºè®®ä»…ç”¨äºæµ‹è¯•ã€‚

## å¼€å‘æŒ‡å—

### ç»„ä»¶è¯´æ˜

- `workflow.yaml`ï¼šå·¥ä½œæµé…ç½®å…¥å£ï¼Œç¼–æ’ Orchestrator / Searcher / Collector / Analyst / Aggregator äº”ä¸ªæ™ºèƒ½ä½“çš„æ‰§è¡Œæµç¨‹ï¼ŒåŸºäºDagWorkflowè¿è¡Œã€‚
- `agent.yaml`ï¼ˆ`orchestrator.yaml`ã€`searcher.yaml`ã€`collector.yaml`ã€`analyst.yaml`ã€`aggregator.yaml`ï¼‰ï¼šå®šä¹‰å„æ™ºèƒ½ä½“ï¼ˆæˆ–è€…å·¥ä½œæµï¼‰çš„è¡Œä¸ºã€å·¥å…·ã€LLM å‚æ•°å’Œæç¤ºè¯ï¼ˆè§’è‰²ä¸èŒè´£ï¼‰ã€‚
- `conf.yaml`ï¼šæœç´¢å¼•æ“é…ç½®ï¼ŒåŒ…å« Exa / SerpAPI ç­‰æœç´¢å·¥å…·çš„ API Key ä¸å‚æ•°è®¾ç½®ã€‚
- `callbacks/`ï¼šå„æ™ºèƒ½ä½“ä¸“å±çš„callbackæ¨¡å—ã€‚
  - `orchestrator_callback.py`ï¼šä¿å­˜ä»»åŠ¡è§„åˆ’åˆ°æœ¬åœ°ã€‚
  - `collector_callback.py`ï¼šä»æœ¬åœ°åŠ è½½ä»»åŠ¡è§„åˆ’å¹¶æ·»åŠ è‡³ç”¨æˆ·æ¶ˆæ¯ã€‚
  - `analyst_callback.py`ï¼šä»æœ¬åœ°åŠ è½½ä»»åŠ¡è§„åˆ’å¹¶ä¿å­˜é‡åŒ–åˆ†ææŠ¥å‘Šåˆ°æœ¬åœ°ã€‚
  - `aggregator_callback.py`ï¼šä¿å­˜æœ€ç»ˆç»¼åˆåˆ†ææŠ¥å‘Šåˆ°æœ¬åœ°ã€‚
  - `file_parser.py`ï¼šä»£ç /JSONæ–‡æœ¬çš„è§£æä¸å¤„ç†ã€‚
- `tools/`ï¼šå·¥å…·ç›®å½•ã€‚
  - `build_jupyter_image.sh`ï¼šæ„å»ºæ²™ç®±æ‰€éœ€çš„ Docker ç¯å¢ƒã€‚
  - `principle_skill.py`ï¼šåŠ è½½ MECE / SWOT / é‡‘å­—å¡”åŸç†ç­‰åˆ†ææ–¹æ³•è®ºã€‚
  - `principles/`ï¼šæŠ¥å‘Šç”Ÿæˆæ‰€ç”¨æ–¹æ³•è®ºçš„ Markdown æ–‡æ¡£ã€‚
- å…¶ä»–å…³é”®æ¨¡å—ï¼š
  - `time_handler.py`ï¼šæ³¨å…¥å½“å‰æ—¥æœŸå’Œæ—¶é—´åˆ°æç¤ºè¯ä¸­ï¼Œé¿å…å‡ºç°å¹»è§‰ã€‚
  - `searcher.py`ï¼šè°ƒç”¨æ·±åº¦ç ”ç©¶é¡¹ç›®è¿›è¡Œèˆ†æƒ…æ£€ç´¢ã€‚
  - `aggregator.py`ï¼šèšåˆèˆ†æƒ…ä¸æ•°æ®åˆ†æä¸¤ç±»ç»“æœå¹¶ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚

### ä½¿ç”¨ç¤ºä¾‹

LLM é…ç½®ç¤ºä¾‹ï¼š

```yaml
llm:
  service: openai
  model: qwen3-max  # Analyst å¯é€‰ qwen3-coder-plus
  openai_api_key: your-api-key
  openai_base_url: https://dashscope.aliyuncs.com/compatible-mode/v1
```

å·¥å…·ï¼ˆæ²™ç®±ï¼‰é…ç½®ç¤ºä¾‹ï¼š

```yaml
tools:
  code_executor:
    sandbox:
      mode: local
      type: docker_notebook
      image: jupyter-kernel-gateway:version1
      timeout: 120
      memory_limit: "1g"
      cpu_limit: 2.0
      network_enabled: true
```

æœç´¢é…ç½®ï¼ˆ`searcher.yaml`ï¼‰ç¤ºä¾‹ï¼š

```yaml
breadth: 3  # æ¯å±‚æœç´¢ç”Ÿæˆçš„æŸ¥è¯¢æ•°
depth: 1    # æœ€å¤§æœç´¢æ·±åº¦
is_report: true  # è¾“å‡ºæŠ¥å‘Šè€Œéç®€çŸ­å›ç­”
```

### è¾“å‡ºç»“æ„

```text
output/
â”œâ”€â”€ plan.json                           # ä»»åŠ¡æ‹†è§£ç»“æœ
â”œâ”€â”€ financial_data/                     # é‡‡é›†çš„é‡‘èæ•°æ®
â”‚   â”œâ”€â”€ stock_prices_*.csv
â”‚   â”œâ”€â”€ quarterly_financials_*.csv
â”‚   â””â”€â”€ ...
â”œâ”€â”€ sessions/                           # æ•°æ®åˆ†ææ™ºèƒ½ä½“çš„ä¼šè¯ç›®å½•
â”‚   â””â”€â”€ session_xxxx/
â”‚       â”œâ”€â”€ *.png                       # ç»˜åˆ¶çš„å›¾è¡¨
â”‚       â””â”€â”€ metrics_*.csv               # è®¡ç®—æŒ‡æ ‡
â”œâ”€â”€ memory/                             # å„æ™ºèƒ½ä½“çš„è®°å¿†å­˜å‚¨ç›®å½•
â”œâ”€â”€ search/                             # èˆ†æƒ…ç ”ç©¶æœç´¢ç»“æœ
â”œâ”€â”€ resources/                          # èˆ†æƒ…ç ”ç©¶æ–‡æ¡£è§£æè·å–çš„å›¾ç‰‡
â”œâ”€â”€ synthesized_findings.md             # å…³é”®å‘ç°æ•´åˆ
â”œâ”€â”€ report_outline.md                   # æŠ¥å‘Šå¤§çº²
â”œâ”€â”€ chapter_1.md                        # ç¬¬1ç« å†…å®¹
â”œâ”€â”€ chapter_2.md                        # ç¬¬2ç« å†…å®¹
â”œâ”€â”€ ...
â”œâ”€â”€ cross_chapter_mismatches.md         # è·¨ç« èŠ‚ä¸€è‡´æ€§æ ¡éªŒç»“æœ
â”œâ”€â”€ analysis_report.md                  # æ•°æ®åˆ†ææŠ¥å‘Š
â”œâ”€â”€ sentiment_report.md                 # èˆ†æƒ…åˆ†ææŠ¥å‘Š
â””â”€â”€ report.md                           # æœ€ç»ˆç»¼åˆæŠ¥å‘Š
```

### æ•°æ®æ”¯æŒèŒƒå›´

å—åˆ°æ•°æ®æ¥å£é™åˆ¶ï¼Œå¯èƒ½å­˜åœ¨ä¸€å®šçš„ç¼ºå¤±å’Œé”™è¯¯ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚

- **å¸‚åœº**ï¼šAè‚¡ï¼ˆsh./sz.ï¼‰ã€æ¸¯è‚¡ï¼ˆhk.ï¼‰ã€ç¾è‚¡ï¼ˆus.ï¼‰
- **æŒ‡æ•°**ï¼šä¸Šè¯50ã€æ²ªæ·±300ï¼ˆHS300ï¼‰ã€ä¸­è¯500ï¼ˆZZ500ï¼‰
- **æ•°æ®ç±»å‹**ï¼šKçº¿ã€è´¢æŠ¥ï¼ˆåˆ©æ¶¦/èµ„äº§è´Ÿå€º/ç°é‡‘æµï¼‰ã€åˆ†çº¢ã€è¡Œä¸šåˆ†ç±»
- **å®è§‚**ï¼šåˆ©ç‡ã€å­˜æ¬¾å‡†å¤‡é‡‘ç‡ã€è´§å¸ä¾›åº”é‡ï¼ˆä¸­å›½ï¼‰

## ğŸ“ TODOs

1. æå‡é‡‘èæ•°æ®æŠ“å–å·¥å…·çš„ç¨³å®šæ€§ä¸è¦†ç›–åº¦ã€‚
2. æŒç»­ä¼˜åŒ–å·¥ä½œæµæ¶æ„ä»¥é™ä½ Token æ¶ˆè€—ã€æå‡æŠ¥å‘Šç”Ÿæˆæ€§èƒ½ã€‚
3. åŠ å¼ºæŠ¥å‘Šçš„å¯è§†åŒ–å‘ˆç°ï¼Œæ”¯æŒå¤šæ ¼å¼å¯¼å‡ºã€‚
4. ä¼˜åŒ–èˆ†æƒ…æœç´¢ä¸ç ”ç©¶pipelineï¼Œä¼˜åŒ–ä¿¡æ¯æºç®¡ç†ã€‚
